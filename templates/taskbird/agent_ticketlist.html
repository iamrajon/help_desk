{% extends "layouts/agent_portal.html" %}
{% load widget_tweaks %}
{% block dynamic_content %}

<style>
    /* Ensure consistent UI for filter and search */
    .filter-container {
        background: white;
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        padding: 1.5rem;
    }
    .search-input {
        width: 100%;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        color: #1f2937;
        transition: border-color 0.2s ease-in-out;
    }
    .search-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
</style>

<div class="pt-20 pb-8 bg-gray-200 min-h-screen px-4 md:px-6">
    <div class="max-w-10xl mx-auto my-4">
        <div class="mb-4 flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-800">Support Tickets</h1>
            <div class="flex items-center space-x-3 me-80 px-10">
                <!-- Plus Icon Button -->
                <button id="open-modal" class="relative inline-flex h-6 w-6 items-center justify-center rounded-full bg-gray-400 hover:bg-gray-500 focus:outline-none transition">
                    <svg class="w-4 h-4 text-green-800" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                </button>
                <span class="text-sm font-medium text-gray-800">Table</span>
                <!-- Toggle Button -->
                <button id="view-toggle" class="relative inline-flex h-6 w-11 items-center rounded-full bg-gray-400 focus:outline-none">
                    <span class="inline-block h-4 w-4 transform rounded-full bg-green-800 transition translate-x-5"></span>
                </button>
                <span class="text-sm font-medium text-gray-800">Cards</span>
            </div>
        </div>

        <!-- Modal -->
        <div id="ticket-modal" class="fixed inset-y-0 right-0 w-96 bg-white shadow-xl transform translate-x-full transition-transform duration-300 ease-in-out z-50">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-lg font-semibold text-gray-800">Create New Ticket</h2>
                <button id="close-modal" class="text-gray-600 hover:text-gray-800">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-4">
                {% include "taskbird/includes/agent_ticket_form.html" %}
            </div>
        </div>

        <!-- Main Content Layout -->
        <div class="flex flex-col lg:flex-row gap-6">
            <!-- Ticket Content -->
            <div id="ticket-content" class="flex-1">
                <!-- Card View -->
                <div id="card-view" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {% for ticket in tickets %}
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden h-64 flex flex-col transition hover:shadow-xl hover:-translate-y-1">
                        <div class="bg-gray-800 text-white px-4 py-3 flex justify-between items-center">
                            <span class="text-sm font-semibold">{{ ticket.ticket_id }}</span>
                            <span class="text-xs">{{ ticket.created_at|date:"M d, Y" }}</span>
                        </div>
                        <div class="p-6 flex-1">
                            <h3 class="text-base font-semibold text-gray-800 truncate">{{ ticket.title }}</h3>
                            <p class="text-sm text-gray-600 mt-2 line-clamp-2">{{ ticket.description }}</p>
                            <div class="mt-4 space-y-2 text-sm">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-500 font-medium">Customer:</span>
                                    <span class="font-medium text-gray-700">{{ ticket.customer.username }}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-500 font-medium">Priority:</span>
                                    <span class="font-medium
                                        {% if ticket.priority.name == 'High' or ticket.priority.name == 'Urgent' %}text-red-600
                                        {% elif ticket.priority.name == 'Medium' %}text-yellow-600
                                        {% else %}text-green-600{% endif %}">
                                        {{ ticket.priority.name|default:"N/A" }}
                                    </span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-500 font-medium">Status:</span>
                                    <span class="font-medium
                                        {% if ticket.status.name == 'Open' %}text-blue-600
                                        {% elif ticket.status.name == 'In Progress' %}text-purple-600
                                        {% elif ticket.status.name == 'Closed' %}text-gray-600
                                        {% else %}text-gray-600{% endif %}">
                                        {{ ticket.status.name|default:"N/A" }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-50 px-4 py-3 flex justify-between items-center border-t border-gray-200">
                            <a href="" class="text-blue-500 hover:text-blue-600 text-sm font-semibold">View Details</a>
                            <span class="text-sm font-medium {% if ticket.is_active %}text-green-600{% else %}text-red-600{% endif %}">
                                {{ ticket.is_active|yesno:"Active,Inactive" }}
                            </span>
                        </div>
                    </div>
                    {% empty %}
                    <div class="bg-white rounded-xl shadow-lg p-6 text-center col-span-full">
                        <p class="text-sm text-gray-600">No tickets found.</p>
                    </div>
                    {% endfor %}
                </div>

                <!-- Table View -->
                <div id="table-view" class="hidden bg-white rounded-xl shadow-lg overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ticket ID</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Priority</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            {% for ticket in tickets %}
                            <tr>
                                <td class="px-4 py-3 text-sm text-gray-900">{{ ticket.ticket_id }}</td>
                                <td class="px-4 py-3 text-sm text-gray-900 truncate max-w-xs">{{ ticket.title }}</td>
                                <td class="px-4 py-3 text-sm text-gray-900">{{ ticket.customer.username }}</td>
                                <td class="px-4 py-3 text-sm
                                    {% if ticket.priority.name == 'High' or ticket.priority.name == 'Urgent' %}text-red-600
                                    {% elif ticket.priority.name == 'Medium' %}text-yellow-600
                                    {% else %}text-green-600{% endif %}">
                                    {{ ticket.priority.name|default:"N/A" }}
                                </td>
                                <td class="px-4 py-3 text-sm
                                    {% if ticket.status.name == 'Open' %}text-blue-600
                                    {% elif ticket.status.name == 'In Progress' %}text-purple-600
                                    {% elif ticket.status.name == 'Closed' %}text-gray-600
                                    {% else %}text-gray-600{% endif %}">
                                    {{ ticket.status.name|default:"N/A" }}
                                </td>
                                <td class="px-4 py-3 text-sm text-gray-900">{{ ticket.created_at|date:"M d, Y" }}</td>
                                <td class="px-4 py-3">
                                    <a href="" class="text-blue-500 hover:text-blue-600 text-sm font-medium">View</a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="px-4 py-3 text-sm text-gray-900 text-center">No tickets found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Filter and Search -->
            <div class="lg:w-80 flex-shrink-0">
                <div class="filter-container p-4 bg-white shadow-lg rounded-lg">
                    <!-- Search Bar -->
                    <div class="mb-4">
                        <label for="search-input" class="block text-sm font-medium text-gray-700 mb-1">Search Tickets</label>
                        <input type="text" name="search" id="search-input" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 placeholder-gray-400" placeholder="Search tickets..." />
                    </div>

                    <div>
                        <h4 class="text-sm font-semibold text-gray-800">Filter Tickets</h4>
                        <!-- Filter Form -->
                        {% include "taskbird/includes/ticket_filter_form.html" %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript for Toggle, Search, and Modal -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Modal Functionality
            const openModalBtn = document.getElementById('open-modal');
            const closeModalBtn = document.getElementById('close-modal');
            const modal = document.getElementById('ticket-modal');

            if (openModalBtn && modal) {
                openModalBtn.addEventListener('click', () => {
                    modal.classList.remove('translate-x-full');
                });
            } else {
                console.error('Modal button or modal element not found');
            }

            if (closeModalBtn && modal) {
                closeModalBtn.addEventListener('click', () => {
                    modal.classList.add('translate-x-full');
                });
            } else {
                console.error('Close button or modal element not found');
            }

            // View Toggle
            const viewToggle = document.getElementById('view-toggle');
            const cardView = document.getElementById('card-view');
            const tableView = document.getElementById('table-view');
            const toggleSpan = viewToggle.querySelector('span');

            if (viewToggle && cardView && tableView && toggleSpan) {
                viewToggle.addEventListener('click', () => {
                    const isCardView = cardView.classList.contains('hidden');
                    cardView.classList.toggle('hidden', !isCardView);
                    tableView.classList.toggle('hidden', isCardView);
                    toggleSpan.classList.toggle('translate-x-5', isCardView);
                    toggleSpan.classList.toggle('translate-x-1', !isCardView);
                });
            } else {
                console.error('View toggle elements not found');
            }

            // Search Bar
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    const searchTerm = searchInput.value.toLowerCase();
                    const cards = cardView.querySelectorAll('.bg-white.rounded-xl');
                    const rows = tableView.querySelectorAll('tbody tr');

                    cards.forEach(card => {
                        const text = card.textContent.toLowerCase();
                        card.style.display = text.includes(searchTerm) ? '' : 'none';
                    });

                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(searchTerm) ? '' : 'none';
                    });
                });
            } else {
                console.error('Search input not found');
            }

            // Reset Filters
            const filterReset = document.getElementById('filter-reset');
            if (filterReset) {
                filterReset.addEventListener('click', () => {
                    document.querySelector('form').reset();
                    searchInput.value = '';
                    searchInput.dispatchEvent(new Event('input'));
                });
            } else {
                console.error('Filter reset button not found');
            }
        });
    </script>
</div>

{% endblock dynamic_content %}